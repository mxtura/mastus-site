# Deployment на Beget (основной домен + admin поддомен)

Этот проект рассчитан на один запуск Next.js сервера, который обслуживает и `domain.tld` и `admin.domain.tld` за счёт определения поддомена в `middleware.ts` (`hostname.startsWith('admin.')`). Разделять код на две разные сборки не нужно.

## Вариант 1 (рекомендуется): оба домена указывают на одну папку
1. Создайте директорию, например: `~/apps/laddex`.
2. Скачайте артефакт GitHub Actions (`next-standalone`) и распакуйте его в эту директорию так, чтобы внутри были:
   - `.next/standalone`
   - `.next/static`
   - `public/`
   - `prisma/schema.prisma`
3. В панели Beget в настройках доменов укажите одной и той же корневой каталог для `laddex.ru` и `admin.laddex.ru` (папка `~/apps/laddex`).
4. Установите переменные окружения (через `~/.bash_profile`, скрипт запуска или менеджер процессов):
   ```bash
   export NODE_ENV=production
   export DATABASE_URL="mysql://user:pass@host:3306/db"
   export NEXTAUTH_SECRET="<32+ bytes secret>"
   export NEXTAUTH_URL="https://laddex.ru"
   export ADMIN_EMAIL="you@yandex.ru"        # если нужна почта
   export ADMIN_EMAIL_PASSWORD="app_pass"    # если нужна почта
   ```
5. Запустите Node сервер (лучше через pm2 или screen):
   ```bash
   cd ~/apps/laddex/.next/standalone
   node server.js
   ```
6. Настройте proxy (если нужен) — на Beget для Node обычно используется Passenger / встроенный запуск. Если у вас тариф без полноценного Node SSR — нужен VPS.

## Если Beget требует разные физические папки
Создайте вторую папку `~/apps/laddex-admin` и сделайте её символической ссылкой на основную:
```bash
ln -s ~/apps/laddex ~/apps/laddex-admin
```
Обе папки будут содержать один и тот же билд. Домены указывают на разные пути, но фактически файловая система одна. (Проверьте, разрешены ли symlink на вашем тарифе.)

## Вариант 2: Две копии билда (нежелательно)
Скопируйте содержимое в две папки и запускайте два процесса на разных портах, затем проксируйте. Минусы: дублирование памяти и необходимость синхронно обновлять. Использовать только если нельзя установить общую папку или symlink.

## Почему нельзя просто развести на два независимых Next
Middleware зависит от проверки поддомена. Код общий (компоненты, Prisma, NextAuth). Разделение приведёт к дублированию логики и рискам рассинхронизации.

## Проверка после запуска
1. Перейдите на `https://laddex.ru` — должен открыться публичный сайт.
2. Перейдите на `https://admin.laddex.ru` — при отсутствии сессии будет редирект на `/login` (реально `/admin/login`).
3. Авторизуйтесь админом — попадёте на `/dashboard`.
4. API проверка (временно, в non-prod): `/api/debug-env` (удалите эндпоинт на проде после проверки).

## Обновление
1. Сборка в GitHub Actions → скачать новый артефакт.
2. Заменить каталоги `.next/standalone` и `.next/static` + при необходимости `public/`.
3. Перезапустить процесс (`pm2 restart <name>` или kill + start).

## Переменные окружения (минимум)
```
DATABASE_URL=...
NEXTAUTH_SECRET=...
NEXTAUTH_URL=https://laddex.ru
NODE_ENV=production
```
Дополнительно при нужде: `ADMIN_EMAIL`, `ADMIN_EMAIL_PASSWORD`.

## Генерация секрета
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

## Частые проблемы
| Проблема | Причина | Решение |
|---------|---------|---------|
| admin.* открывает публичный сайт | Домены указывают в разные папки | Установить общий корень / symlink |
| 404 на /login админки | Нет поддомена admin.* | Проверьте DNS и host заголовок |
| Ошибка БД при старте | Неверный DATABASE_URL | Исправить строку, проверить порт/доступ |
| Unauthorized в админке | NEXTAUTH_SECRET различается между логином и сервером | Убедитесь в одном значении |

## Итог
Один Node процесс + оба домена смотрят в одну директорию — самый простой и поддерживаемый путь.
