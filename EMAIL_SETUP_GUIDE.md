# Настройка системы отправки email

## Обзор функциональности

Система обеспечивает:
1. **Отправку сообщений с сайта** через форму обратной связи
2. **Автоматическое уведомление администратора** о новых сообщениях
3. **Автоответ клиенту** с подтверждением получения
4. **Админ-панель** для просмотра, ответа и управления сообщениями
5. **SMTP интеграцию с Яндекс почтой**

## Пошаговая настройка

### 1. Настройка Яндекс почты

1. **Создайте аккаунт на Яндексе** (если его нет)
2. **Включите двухфакторную аутентификацию**:
   - Перейдите в настройки безопасности Яндекс ID
   - Включите 2FA

3. **Создайте пароль приложения**:
   - Перейдите в https://id.yandex.ru/security/app-passwords
   - Нажмите "Создать пароль приложения"
   - Выберите "Почта" → "Другое приложение"
   - Введите название: "Laddex Website"
   - Скопируйте сгенерированный пароль

### 2. Установка зависимостей

```bash
npm install nodemailer @types/nodemailer
```

### 3. Настройка переменных окружения

Создайте файл `.env.local` в корне проекта:

```env
# Настройки SMTP Яндекс
YANDEX_EMAIL_USER="your-email@yandex.ru"
YANDEX_EMAIL_PASSWORD="generated-app-password"

# Email для получения уведомлений (может быть тот же или другой)
ADMIN_EMAIL="admin@yourdomain.com"

# URL вашего сайта
NEXTAUTH_URL="https://yourdomain.com"
```

### 4. Обновление базы данных

Выполните миграцию Prisma:

```bash
npx prisma db push
```

### 5. Тестирование системы

1. **Отправьте тестовое сообщение** через форму на `/contacts`
2. **Проверьте почту администратора** - должно прийти уведомление
3. **Проверьте почту отправителя** - должен прийти автоответ
4. **Зайдите в админ-панель** `/admin/messages` - сообщение должно отображаться

## Структура файлов

```
src/
├── lib/
│   └── email.ts                    # Конфигурация SMTP и шаблоны
├── app/
│   ├── api/
│   │   └── messages/
│   │       ├── route.ts            # API для создания/получения сообщений
│   │       └── [id]/
│   │           ├── route.ts        # API для работы с отдельным сообщением
│   │           └── reply/
│   │               └── route.ts    # API для ответа на сообщение
│   ├── (main)/
│   │   └── contacts/
│   │       └── page.tsx            # Форма обратной связи
│   └── admin/
│       └── messages/
│           └── page.tsx            # Админ-панель для сообщений
```

## Функции админ-панели

### Просмотр сообщений
- Список всех сообщений с информацией об отправителе
- Статусы: Новое → В обработке → Обработано → Архив
- Автоматическое изменение статуса при просмотре

### Ответ на сообщения
- Диалог для написания ответа
- Автоматическое включение исходного сообщения
- HTML-шаблон письма с брендингом
- Автоматическое изменение статуса на "Обработано"

### Управление
- Изменение статуса сообщения
- Удаление сообщений
- Быстрые действия (телефон, email)

## Шаблоны писем

### Уведомление администратору
- Полная информация об отправителе
- Текст сообщения
- Ссылка на админ-панель

### Автоответ клиенту
- Подтверждение получения
- Информация о времени ответа
- Контактные данные компании

### Ответ от администратора
- Персонализированный ответ
- Исходное сообщение в контексте
- Брендинг компании

## Безопасность

### Валидация данных
- Проверка обязательных полей
- Валидация email адресов
- Согласие на обработку данных

### Защита API
- Аутентификация для админ-функций
- Rate limiting (при необходимости)
- Проверка прав доступа

### Обработка ошибок
- Graceful handling отправки email
- Логирование ошибок
- Fallback при недоступности SMTP

## Настройка домена и DNS

Для корректной работы email рекомендуется:

1. **SPF запись** в DNS:
```
TXT @ "v=spf1 include:_spf.yandex.net ~all"
```

2. **DKIM** (настраивается в Яндекс.Почте для домена)

3. **DMARC** для защиты от спуфинга:
```
TXT _dmarc "v=DMARC1; p=quarantine; rua=mailto:admin@yourdomain.com"
```

## Мониторинг

### Логирование
- Все отправки email логируются в консоль
- Ошибки SMTP сохраняются в логи
- ID сообщений для отслеживания

### Метрики (рекомендуется добавить)
- Количество отправленных сообщений
- Время ответа администратора
- Конверсия обращений

## Дополнительные возможности

### Будущие улучшения
1. **Шаблоны ответов** для быстрых ответов
2. **Файловые вложения** в сообщениях
3. **Уведомления в реальном времени** (WebSocket)
4. **Интеграция с CRM** системами
5. **Аналитика** обращений клиентов

### Альтернативные сервисы
Вместо Яндекс SMTP можно использовать:
- **SendGrid** (бесплатно до 100 писем/день)
- **AWS SES** (очень дешево, надежно)
- **Mailgun** (бесплатно до 5000 писем/месяц)
- **Resend** (современный API)

## Troubleshooting

### Частые проблемы

1. **Письма не отправляются**:
   - Проверьте пароль приложения Яндекс
   - Убедитесь что 2FA включена
   - Проверьте настройки SMTP (порт 587, TLS)

2. **Письма попадают в спам**:
   - Настройте SPF/DKIM/DMARC записи
   - Используйте корпоративный email домен
   - Избегайте спам-слов в тексте

3. **Ошибки в админ-панели**:
   - Проверьте права администратора
   - Убедитесь что база данных доступна
   - Проверьте логи в консоли браузера

### Команды для диагностики

```bash
# Проверка подключения к базе данных
npx prisma db pull

# Проверка схемы
npx prisma generate

# Просмотр логов
npm run dev
```

## Заключение

Система готова к использованию и обеспечивает полный цикл обработки обращений клиентов. Убедитесь, что все переменные окружения настроены правильно, и протестируйте отправку сообщений перед запуском в продакшн.
